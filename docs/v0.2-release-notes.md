# v0.2 Release Notes

## Overview

Version 0.2 adds Docker storage detection and cleanup. Docker is one of the largest sources of disk bloat for developers, typically consuming 10-50 GB or more. This release handles Docker API resources (images, containers, volumes, build cache) and Docker Desktop VM disk files.

## What's New

### Docker Storage Detection (#3)

Queries the Docker daemon API to detect:
- Images (total and reclaimable size)
- Containers (total and reclaimable size)
- Volumes (total and reclaimable size)
- Build cache (total and reclaimable size)

The detector handles edge cases gracefully:
- Docker not installed: skips detection
- Docker daemon not running: reports diagnostic message
- Permission denied: reports diagnostic message

Implementation uses `docker system df --format json` for accurate size reporting.

### Docker Cleanup (#47)

Cleanup now works for all Docker object types using prune commands:
- `docker image prune -a -f` for images
- `docker container prune -f` for containers
- `docker volume prune -f` for volumes
- `docker builder prune -a -f` for build cache

The `-f` flag makes cleanup non-interactive. Use `--category container-data` to clean only Docker resources.

### Docker Desktop VM Detection (#42)

**Status: Implemented but untested on target platforms**

Docker Desktop on macOS and Windows stores all container data in VM disk images. These files grow to 30-60 GB and don't automatically shrink when you delete containers or images inside the VM.

Detected paths:
- macOS: `~/Library/Containers/com.docker.docker/Data/vms/0/data/Docker.raw`
- Windows: `%USERPROFILE%\AppData\Local\Docker\wsl\data\ext4.vhdx`

This feature is implemented based on Docker Desktop documentation but hasn't been tested on actual macOS or Windows hardware yet. We need community testing to verify:
1. File paths are correct for default Docker Desktop installations
2. Reported sizes match actual disk usage
3. Cleanup hints work as documented

If you're on macOS or Windows with Docker Desktop installed, please test and report results in issue #42.

## Implementation Details

### Code Changes

**src/scan/docker.rs:**
- Added `detect_docker_desktop_vm()` function
- Modified `scan()` to check for VM files on macOS/Windows
- Added platform-specific cleanup hints
- VM detection uses `platform::detect()` and `platform::home_dir()`
- File existence and size checks use standard library filesystem APIs

**src/clean/mod.rs:**
- Modified aggregate filter to allow Docker aggregate types through
- Added `is_docker_aggregate()` helper function
- Added `delete_docker_aggregate()` function that maps aggregate types to prune commands
- Removed `unreachable!()` panic for aggregate locations

### Platform Support Matrix

| Platform | Docker API | Docker Desktop VM | Cleanup |
|----------|------------|-------------------|---------|
| Linux    | Working    | N/A               | Working |
| macOS    | Working    | Needs testing     | Working |
| Windows  | Working    | Needs testing     | Working |

Docker Desktop VM detection only applies to macOS and Windows. Linux users running docker engine don't have VM disk files.

### Testing Status

Tested and verified:
- Docker API detection on Linux
- Cleanup dry-run and execution
- Error handling (daemon not running, permission denied)
- Multiple category cleanup
- JSON output format
- Integration with existing detectors

Needs community testing:
- macOS VM file detection
- Windows VM file detection
- macOS cleanup hints (verify commands work)
- Windows cleanup hints (verify commands work)

## Known Limitations

1. **VM reclaimable space**: Reports 0 for reclaimable bytes on VM disk files because we can't determine how much space is reclaimable without analyzing VM internals. Use the cleanup hints to reclaim space.

2. **Bytes freed estimation**: Cleanup reports bytes freed based on scan-time reclaimable amounts, not actual prune results. Docker state can change between scan and cleanup.

3. **Custom Docker Desktop paths**: VM detection assumes default installation paths. Custom installation locations aren't supported yet.

4. **Cleanup hint inconsistency**: Hints in scan output show interactive commands (`docker image prune -a`) but actual cleanup uses non-interactive versions with `-f` flag. This is intentional - hints are for manual use, cleanup automates it.

## How to Test Docker Desktop VM Detection

### macOS

1. Check if Docker.raw exists:
   ```bash
   ls -lh ~/Library/Containers/com.docker.docker/Data/vms/0/data/Docker.raw
   ```

2. Run heft scan:
   ```bash
   cargo run -- scan --verbose
   ```

3. Verify the reported size matches your actual file size

4. Test cleanup hint:
   - Open Docker Desktop → Settings → Resources → Disk image size
   - Click "Clean/Purge data"
   - Or run `docker system prune -a` and restart Docker Desktop

5. Report results in issue #42

### Windows

1. Check if ext4.vhdx exists:
   ```powershell
   Get-Item "$env:USERPROFILE\AppData\Local\Docker\wsl\data\ext4.vhdx"
   ```

2. Run heft scan:
   ```powershell
   cargo run -- scan --verbose
   ```

3. Verify the reported size matches your actual file size

4. Test cleanup hint:
   ```powershell
   wsl --shutdown
   Optimize-VHD -Path "$env:USERPROFILE\AppData\Local\Docker\wsl\data\ext4.vhdx" -Mode Full
   ```
   (Requires admin PowerShell)

5. Report results in issue #42

## Upgrade Notes

- No breaking changes
- Docker detection is automatic if docker is installed
- Use `--skip-docker` CLI flag to disable detection
- Cleanup requires `--yes` flag for execution (dry-run by default)

## What's Next

After v0.2 stabilizes and Docker Desktop VM detection is verified:
- Snapshot storage (#6) - save scan results to SQLite
- Diff engine (#7) - compare snapshots over time
- Platform-specific detectors (#22, #28, #23)

## Contributing

Docker Desktop VM detection needs testing on macOS and Windows. If you have access to these platforms, please help verify the implementation works correctly. See issue #42 for testing instructions and to report results.
